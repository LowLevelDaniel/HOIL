FROM ubuntu:22.04

# Set up environment
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    clang \
    ninja-build \
    python3 \
    python3-pip \
    python3-dev \
    valgrind \
    gdb \
    lcov \
    doxygen \
    graphviz \
    git \
    vim \
    nano \
    less \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install meson
RUN pip3 install meson pytest

# Set up working directory
WORKDIR /app

# Copy source code
COPY . .

# Create build directory
RUN mkdir -p build && \
    cd build && \
    meson setup .. && \
    meson compile

# Create examples directory
RUN mkdir -p examples

# Copy example files
COPY test/*.hoil examples/

# Add a helper script for building and running examples
RUN echo '#!/bin/bash\n\
build_and_run() {\n\
  echo "Building $1..."\n\
  ./build/hoil_to_coil -b examples/$1.hoil examples/$1.coil\n\
  echo "Running $1..."\n\
  ./build/coil_vm -b -s examples/$1.coil\n\
}\n\
\n\
if [ "$1" == "" ]; then\n\
  echo "Available examples:"\n\
  ls examples/*.hoil | sed "s/.*\\/\\(.*\\)\\.hoil/  \\1/"\n\
  echo "Usage: ./run.sh <example_name>"\n\
else\n\
  build_and_run $1\n\
fi' > /app/run.sh && chmod +x /app/run.sh

# Set entrypoint
ENTRYPOINT ["/bin/bash"]

# Default command - show available examples
CMD ["echo", "HOIL-COIL Development Environment", "&&", "echo", "Run './run.sh' to see available examples"]